<script>
/* ========= CẤU HÌNH ========= */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQFLOQCFAQqdcQLP4Yxy0IAVk2f1GCs3nTpEdrITr5s47wOAdViQ3K0VkcQLQSRoLehUe8jFfXrvjkm/pub?output=csv";
const VN_BOX    = { latMin: 7, latMax: 25, lngMin: 100, lngMax: 112 };
const VN_CENTER = { lat: 16.05, lng: 108.2 };

/* ========= MAP ========= */
const map = L.map('map', { preferCanvas:true }).setView([VN_CENTER.lat, VN_CENTER.lng], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'© OpenStreetMap' }).addTo(map);
const group = L.layerGroup().addTo(map);
const $status = document.getElementById('status');

/* ========= URL PARAMS ========= */
function getParam(name){
  const u = new URL(location.href);
  return u.searchParams.get(name);
}
function buildInitialQueryFromURL(){
  const q = getParam('q');
  if (q && q.trim()) return q.trim();

  const ma = getParam('ma'); // ví dụ: KH001,KH002|KH005  hoặc  "KH001 KH002"
  if (ma && ma.trim()){
    const list = ma.split(/[,\s|;]+/).filter(Boolean);
    return 'ma: ' + list.join(' ');
  }
  return ''; // không có tham số → để trống
}

/* ========= HELPERS ========= */
function inVN(lat,lng){ return lat>=VN_BOX.latMin && lat<=VN_BOX.latMax && lng>=VN_BOX.lngMin && lng<=VN_BOX.lngMax; }
function d2VN(lat,lng){ const dx=lat-VN_CENTER.lat, dy=lng-VN_CENTER.lng; return dx*dx+dy*dy; }

/* Đọc số an toàn */
function toNumSmart(x){
  if (typeof x === 'number') return x;
  if (x == null) return NaN;
  let s = String(x).trim();
  if (/^\d{1,3}(\.\d{3})+(,\d+)?$/.test(s)) s = s.replace(/\./g,'').replace(',', '.');
  s = s.replace(/[^\d\.\,\-]/g,'');
  if (s.includes('.') && s.includes(',')) {
    if (s.lastIndexOf(',') < s.lastIndexOf('.')) s = s.replace(/,/g,'');  else s = s.replace(/\./g,'').replace(',', '.');
  } else if (s.includes(',')) s = s.replace(',', '.');
  const n = Number(s);
  return Number.isFinite(n)? n : NaN;
}

/* Thử đảo cột + chia e5/e6/e7 */
const SCALES = [1, 1e5, 1e6, 1e7];
function bestFix(latRaw, lngRaw){
  const a = toNumSmart(latRaw), b = toNumSmart(lngRaw);
  const cand = [];
  function push(lat,lng,label){
    if(Number.isFinite(lat) && Number.isFinite(lng) && Math.abs(lat)<=90 && Math.abs(lng)<=180){
      cand.push({lat:+lat.toFixed(6), lng:+lng.toFixed(6), inside:inVN(lat,lng), d2:d2VN(lat,lng), label});
    }
  }
  for (const k of SCALES){
    push(a/k, b/k, `latlng_${k}`); // giữ (lat,lng)
    push(b/k, a/k, `swap_${k}`);   // đảo (lng,lat)
  }
  if (!cand.length) return null;
  cand.sort((p,q)=>{
    if (p.inside !== q.inside) return q.inside ? 1 : -1;
    if (p.d2 !== q.d2) return p.d2 - q.d2;
    return 0;
  });
  return cand[0];
}

/* Đoán tên cột */
function guessKey(obj, alts){
  const keys = Object.keys(obj);
  for (const name of alts){
    const k = keys.find(k => k.toLowerCase().trim() === name);
    if (k) return k;
  }
  for (const name of alts){
    const k = keys.find(k => k.toLowerCase().includes(name));
    if (k) return k;
  }
  return null;
}

/* Parse CSV (PapaParse nếu có) */
function parseCSV(text){
  if (window.Papa) {
    const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
    if (parsed.errors && parsed.errors.length){ console.warn('Papa errors:', parsed.errors.slice(0,3)); }
    return parsed.data;
  }
  const rows = text.trim().split(/\r?\n/);
  const header = rows.shift().split(',').map(s=>s.trim());
  return rows.map(line=>{
    const cols = line.split(','); // fallback đơn giản
    const obj = {};
    for (let i=0;i<header.length;i++) obj[header[i]] = cols[i] ?? '';
    return obj;
  });
}

/* Popup */
function makePopup(r){
  const esc = s => String(s??'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return `<div style="min-width:220px">
    <b>${esc(r.ten||'(không tên)')}</b><br>
    ${r.ma_kh?`<span style="color:#6b7280">${esc(r.ma_kh)}</span><br>`:''}
    ${r.dia_chi?`📍 ${esc(r.dia_chi)}<br>`:''}
    ${r.dien_thoai?`☎️ ${esc(r.dien_thoai)}<br>`:''}
  </div>`;
}

/* Vẽ marker (circle) */
function makeMarker(lat, lng, popupHtml){
  const color = '#1d4ed8';
  return L.circleMarker([lat,lng], {
    radius: 5, weight: 1, color, fillColor: color, fillOpacity: 0.85
  }).bindPopup(popupHtml);
}

/* ====== LỌC: hỗ trợ "ma:", "ten:", "dc:", "sdt:" + nhiều giá trị ====== */
function parseQuery(q) {
  const out = { any: [], ma: [], ten: [], dc: [], sdt: [] };
  let cur = null;
  for (const raw of q.split(/[,\s;]+/)) {
    const tok = raw.trim(); if (!tok) continue;
    let m = tok.match(/^(ma|ten|dc|sdt):$/i);
    if (m) { cur = m[1].toLowerCase(); continue; }
    m = tok.match(/^(ma|ten|dc|sdt):(.*)$/i);
    if (m) {
      cur = m[1].toLowerCase();
      const val = m[2].trim();
      if (val) out[cur].push(val.toLowerCase());
      continue;
    }
    if (cur) out[cur].push(tok.toLowerCase());
    else out.any.push(tok.toLowerCase());
  }
  return out;
}
function rowMatches(r, f) {
  const sAll = `${r.ma_kh||''} ${r.ten||''} ${r.dia_chi||''} ${r.dien_thoai||''} ${r.mo_ta||''}`.toLowerCase();
  const ma  = (r.ma_kh||'').toLowerCase();
  const ten = (r.ten||'').toLowerCase();
  const dc  = (r.dia_chi||'').toLowerCase();
  const sdt = (r.dien_thoai||'').toLowerCase();

  if (f.ma.length  && !f.ma.some(x => ma.includes(x)))   return false;
  if (f.ten.length && !f.ten.some(x => ten.includes(x)))  return false;
  if (f.dc.length  && !f.dc.some(x  => dc.includes(x)))    return false;
  if (f.sdt.length && !f.sdt.some(x => sdt.includes(x)))   return false;

  if (f.any.length && !f.any.every(x => sAll.includes(x))) return false;
  return true;
}

/* ========= NẠP & VẼ ========= */
const STATE = { rows: [], keys: {} };

function renderFiltered(q){
  const vnOnly = document.getElementById('vnOnly').checked;
  const filt = q ? parseQuery(q) : null;

  group.clearLayers();
  const bounds = L.latLngBounds();
  let shown = 0;

  for (const r of STATE.rows){
    if (vnOnly && !r._inside) continue;
    if (filt && !rowMatches(r, filt)) continue;

    const m = makeMarker(r.lat, r.lng, makePopup(r));
    m.addTo(group);
    bounds.extend([r.lat, r.lng]);
    shown++;
  }

  if (shown && bounds.isValid()) map.fitBounds(bounds.pad(0.15));
  $status.textContent = `Hiển thị ${shown}/${STATE.rows.length} điểm` + (filt?` · lọc: "${q}"`:'');
}

document.getElementById('reload').onclick = async ()=>{
  try{
    document.getElementById('status').textContent='Đang tải dữ liệu…';
    group.clearLayers();

    const res = await fetch(CSV_URL + '&t=' + Date.now(), { cache:'no-store' });
    const text = await res.text();
    if (!text || !/[,;\n]/.test(text)) { document.getElementById('status').textContent='CSV rỗng/không hợp lệ'; return; }

    const data = parseCSV(text);
    if (!Array.isArray(data) || data.length===0) { document.getElementById('status').textContent='Không có dữ liệu'; return; }

    // đoán cột
    const sample = data[0];
    const latKey = guessKey(sample, ['lat','latitude','vido','vi_do','vĩ độ','y','vi do']) || 'lat';
    const lngKey = guessKey(sample, ['lng','lon','longitude','kinhdo','kinh_do','kinh độ','x','kinh do']) || 'lng';
    const tenKey = guessKey(sample, ['ten','tên']) || 'ten';
    const dcKey  = guessKey(sample, ['dia_chi','địa chỉ','dia chi']) || 'dia_chi';
    const maKey  = guessKey(sample, ['ma_kh','mã khách hàng','ma kh','ma']) || 'ma_kh';
    const sdtKey = guessKey(sample, ['dien_thoai','điện thoại','dien thoai','sdt','phone']) || 'dien_thoai';
    STATE.keys = {latKey,lngKey,tenKey,dcKey,maKey,sdtKey};

    // chuẩn hoá
    const rows = [];
    let total=0, kept=0;
    for (const r of data){
      total++;
      const best = bestFix(r[latKey], r[lngKey]);
      if (!best) continue;
      const row = {
        ma_kh: r[maKey]||'',
        ten: r[tenKey]||'',
        dia_chi: r[dcKey]||'',
        dien_thoai: r[sdtKey]||'',
        lat: best.lat, lng: best.lng, _inside: best.inside
      };
      rows.push(row); kept++;
    }
    STATE.rows = rows;

    // điền ô lọc từ URL nếu có
    const initialQ = buildInitialQueryFromURL();
    const $q = document.getElementById('q');
    if (initialQ) $q.value = initialQ;

    // vẽ theo lọc (nếu có), mặc định chỉ VN (checkbox)
    renderFiltered(initialQ);

    document.getElementById('status').textContent = `Đã đọc ${kept}/${total} dòng.`;
  }catch(e){
    console.error(e);
    document.getElementById('status').textContent='Lỗi: '+e.message;
  }
};

/* gõ lọc trực tiếp */
document.getElementById('q').addEventListener('input', e=>{
  const q = e.target.value.trim();
  renderFiltered(q);
});

/* tự chạy lần đầu: sẽ dùng tham số URL nếu có */
document.getElementById('reload').click();
</script>
